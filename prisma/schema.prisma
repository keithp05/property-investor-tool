// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// USER & AUTHENTICATION
// ============================================================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime?
  password      String    // bcrypt hashed
  name          String?
  image         String?
  role          UserRole  @default(TENANT)

  // Subscription
  subscriptionTier   SubscriptionTier @default(FREE)
  stripeCustomerId   String?          @unique
  stripeSubscriptionId String?        @unique
  subscriptionStatus SubscriptionStatus @default(INACTIVE)
  subscriptionEndsAt DateTime?

  // Relations
  accounts      Account[]
  sessions      Session[]
  landlordProfile LandlordProfile?
  tenantProfile   TenantProfile?
  tenantApplications TenantApplication[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([email])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ============================================================================
// LANDLORD & TENANT PROFILES
// ============================================================================

model LandlordProfile {
  id              String   @id @default(cuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Business Info
  phone           String?
  company         String?
  businessAddress String?

  // QuickBooks Integration
  quickbooksEnabled    Boolean @default(false)
  quickbooksCompanyId  String?
  quickbooksRealmId    String?
  quickbooksAccessToken String?
  quickbooksRefreshToken String?
  quickbooksTokenExpiry DateTime?

  // Relations
  properties      Property[]
  tenants         Tenant[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model TenantProfile {
  id              String   @id @default(cuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Contact Info
  phone           String?
  emergencyContact String?
  emergencyPhone   String?

  // Current Rental
  currentTenancy  Tenant?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// ============================================================================
// PROPERTIES
// ============================================================================

model Property {
  id              String   @id @default(cuid())
  landlordId      String
  landlord        LandlordProfile @relation(fields: [landlordId], references: [id], onDelete: Cascade)

  // Property Details (auto-fetched from Zillow)
  address         String
  city            String
  state           String
  zipCode         String
  latitude        Float?
  longitude       Float?

  bedrooms        Int
  bathrooms       Float
  squareFeet      Int?
  yearBuilt       Int?
  propertyType    String
  estimatedValue  Decimal?

  // Landlord Purchase Info
  purchasePrice   Decimal?
  purchaseDate    DateTime?

  // Mortgage Details
  monthlyMortgage Decimal?
  mortgageBalance Decimal?      // Current amount owed
  mortgageRate    Float?         // Interest rate
  mortgageTerm    Int?           // Term in months (e.g., 360 for 30 years)
  mortgageStartDate DateTime?
  lenderName      String?
  loanNumber      String?

  // Equity Tracking
  currentValue    Decimal?       // Auto-updated from Zillow API
  availableEquity Decimal?       // Calculated: currentValue - mortgageBalance
  lastValueUpdate DateTime?

  // Bank Integration (Plaid)
  plaidAccessToken String?
  plaidItemId      String?
  plaidAccountId   String?
  plaidLinked      Boolean @default(false)
  plaidLastSync    DateTime?

  // Payment Status
  mortgagePaymentStatus String? // CURRENT, LATE, BEHIND
  lastPaymentDate       DateTime?
  nextPaymentDue        DateTime?
  missedPayments        Int @default(0)

  // Refinance Tracking
  shouldConsiderRefi  Boolean @default(false)
  refiRecommendation  String?  // System-generated recommendation

  // Rental Info
  monthlyRent     Decimal?
  marketRent      Decimal?       // Market rate rent from AI analysis
  securityDeposit Decimal?

  // Section 8 Housing Info
  section8FMR     Decimal?       // HUD Fair Market Rent for this property
  section8ContactName    String?  // Local housing authority name
  section8ContactPhone   String?  // Housing authority phone
  section8ContactWebsite String?  // Housing authority website

  // Status
  status          PropertyStatus @default(VACANT)

  // Relations
  currentTenancy  Tenant?
  photos          PropertyPhoto[]
  maintenanceRequests MaintenanceRequest[]
  rentPayments    RentPayment[]
  tenantApplications TenantApplication[]
  weatherData     WeatherData[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([landlordId])
  @@index([zipCode])
}

model PropertyPhoto {
  id              String   @id @default(cuid())
  propertyId      String
  property        Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  // Storage (cloud-agnostic)
  storageProvider StorageProvider
  s3Bucket        String?
  s3Key           String?
  gcsBucket       String?
  gcsPath         String?
  azureContainer  String?
  azurePath       String?

  imageUrl        String   // CDN URL
  thumbnailUrl    String?

  photoType       PhotoType
  uploadedBy      String   // userId
  uploadedAt      DateTime @default(now())

  // AI Analysis
  aiAnalyzed      Boolean @default(false)
  aiDamageDetected Boolean @default(false)
  damageDescription String?
  estimatedRepairCost Decimal?
  damageCategory  String?
  aiConfidence    Float?   // 0-1 confidence score

  // Auto-deletion for tenant photos
  deleteAt        DateTime? // Set when tenant moves out

  @@index([propertyId, photoType])
}

// ============================================================================
// TENANTS & LEASES
// ============================================================================

model Tenant {
  id              String   @id @default(cuid())

  // User Account
  tenantProfileId String   @unique
  tenantProfile   TenantProfile @relation(fields: [tenantProfileId], references: [id], onDelete: Cascade)

  // Landlord Relationship
  landlordId      String
  landlord        LandlordProfile @relation(fields: [landlordId], references: [id])

  // Property Assignment
  propertyId      String   @unique
  property        Property @relation(fields: [propertyId], references: [id])

  // Lease Terms
  leaseStartDate  DateTime
  leaseEndDate    DateTime
  monthlyRent     Decimal
  securityDeposit Decimal
  leaseSigned     Boolean @default(false)
  leaseSignedDate DateTime?

  // Auto-Pay
  autoPayEnabled  Boolean @default(false)
  autoPayMethod   String? // STRIPE, ACH

  // Relations
  rentPayments    RentPayment[]
  maintenanceRequests MaintenanceRequest[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([landlordId])
  @@index([propertyId])
}

// ============================================================================
// RENT PAYMENTS
// ============================================================================

model RentPayment {
  id              String   @id @default(cuid())
  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id])
  propertyId      String
  property        Property @relation(fields: [propertyId], references: [id])

  // Payment Details
  amount          Decimal
  dueDate         DateTime
  paidDate        DateTime?
  status          PaymentStatus @default(PENDING)

  // Payment Method
  paymentMethod   PaymentMethod?

  // Stripe
  stripePaymentIntentId String?
  stripeChargeId        String?

  // ACH
  plaidAccountId        String?

  // Venmo/Zelle
  externalTransactionId String?

  // Late Fees
  lateFee         Decimal?
  lateFeeApplied  DateTime?

  // QuickBooks Sync
  quickbooksSynced Boolean @default(false)
  quickbooksInvoiceId String?
  quickbooksPaymentId String?
  quickbooksSyncedAt  DateTime?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([tenantId, dueDate])
  @@index([status])
}

// ============================================================================
// MAINTENANCE REQUESTS
// ============================================================================

model MaintenanceRequest {
  id              String   @id @default(cuid())
  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id])
  propertyId      String
  property        Property @relation(fields: [propertyId], references: [id])

  title           String
  description     String
  priority        Priority @default(MEDIUM)
  status          RequestStatus @default(OPEN)
  category        String?  // PLUMBING, ELECTRICAL, HVAC, etc.

  // Photos
  photos          MaintenancePhoto[]

  // AI Analysis
  aiAnalyzed      Boolean @default(false)
  aiEstimatedCost Decimal?
  aiDescription   String?
  aiUrgency       Priority?
  aiContractorSuggestion String?

  // Contractor Assignment
  assignedTo      String?
  scheduledDate   DateTime?

  createdAt       DateTime @default(now())
  resolvedAt      DateTime?
  updatedAt       DateTime @updatedAt

  @@index([tenantId])
  @@index([propertyId, status])
}

model MaintenancePhoto {
  id              String   @id @default(cuid())
  requestId       String
  request         MaintenanceRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)

  // Storage (cloud-agnostic)
  storageProvider StorageProvider
  s3Key           String?
  gcsPath         String?
  azurePath       String?

  imageUrl        String
  thumbnailUrl    String?

  uploadedAt      DateTime @default(now())

  // Auto-deletion when request resolved + 90 days
  deleteAt        DateTime?

  @@index([requestId])
}

// ============================================================================
// WEATHER DATA (Cached)
// ============================================================================

model WeatherData {
  id              String   @id @default(cuid())
  propertyId      String
  property        Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  // Location
  zipCode         String
  city            String
  state           String

  // Current Weather
  temperature     Float
  feelsLike       Float
  humidity        Int
  condition       String   // SUNNY, CLOUDY, RAINY, etc.
  windSpeed       Float

  // Forecast
  forecastData    Json?    // 7-day forecast

  // Cache
  fetchedAt       DateTime @default(now())
  expiresAt       DateTime // Refresh every 30 minutes

  @@index([propertyId])
  @@index([expiresAt])
}

// ============================================================================
// ENUMS
// ============================================================================

enum UserRole {
  ADMIN
  LANDLORD
  TENANT
}

enum SubscriptionTier {
  FREE
  PRO
  ENTERPRISE
}

enum SubscriptionStatus {
  ACTIVE
  INACTIVE
  PAST_DUE
  CANCELLED
  TRIALING
}

enum PropertyStatus {
  VACANT
  RENTED
  MAINTENANCE
  PENDING_LEASE
}

enum PhotoType {
  MOVE_IN
  MOVE_OUT
  MAINTENANCE
  GENERAL
}

enum StorageProvider {
  AWS_S3
  GCP_STORAGE
  AZURE_BLOB
}

enum PaymentMethod {
  STRIPE_CARD
  STRIPE_ACH
  PLAID_ACH
  VENMO
  ZELLE
  CASH
  CHECK
}

enum PaymentStatus {
  PENDING
  PROCESSING
  PAID
  LATE
  FAILED
  REFUNDED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  EMERGENCY
}

enum RequestStatus {
  OPEN
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

// ============================================================================
// TENANT APPLICATIONS
// ============================================================================

enum ApplicationStatus {
  PENDING
  SUBMITTED
  REVIEWING
  APPROVED
  DENIED
}

model TenantApplication {
  id                  String            @id @default(cuid())
  propertyId          String
  landlordId          String
  applicationLink     String            @unique
  status              ApplicationStatus @default(PENDING)

  // Primary Applicant Info
  fullName            String?
  email               String?
  phone               String?
  dateOfBirth         DateTime?
  ssn                 String?

  // Current Employment
  employerName        String?
  employerPhone       String?
  jobTitle            String?
  monthlyIncome       Float?
  employmentStartDate DateTime?

  // Previous Employment (if less than 2 years)
  previousEmployerName        String?
  previousEmployerPhone       String?
  previousJobTitle            String?
  previousEmploymentStartDate DateTime?
  previousEmploymentEndDate   DateTime?

  // References
  reference1Name         String?
  reference1Phone        String?
  reference1Relationship String?
  reference2Name         String?
  reference2Phone        String?
  reference2Relationship String?

  // Current Address
  currentAddress       String?
  currentCity          String?
  currentState         String?
  currentZip           String?
  currentLandlord      String?
  currentLandlordPhone String?
  currentMonthlyRent   Float?
  currentMoveInDate    DateTime?

  // Previous Address (if less than 2 years at current)
  previousAddress       String?
  previousCity          String?
  previousState         String?
  previousZip           String?
  previousLandlord      String?
  previousLandlordPhone String?

  // Pets
  hasPets    Boolean @default(false)
  petDetails Json?

  // Additional Occupants
  additionalOccupants Json?

  // Second Applicant
  hasSecondApplicant Boolean @default(false)
  secondApplicantInfo Json?

  // Documents
  payStubsUrls  String[]
  idDocumentUrl String?

  // Screening Results
  creditCheckId            String?
  creditScore              Int?
  creditReportUrl          String?
  backgroundCheckId        String?
  backgroundCheckStatus    String?
  backgroundCheckReportUrl String?

  // Payment
  applicationFee         Float   @default(50.00)
  applicationFeePaid     Boolean @default(false)
  stripePaymentIntentId  String?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  submittedAt DateTime?

  // Relations
  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  landlord User     @relation(fields: [landlordId], references: [id], onDelete: Cascade)

  @@index([propertyId])
  @@index([landlordId])
  @@index([applicationLink])
}
